<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <table>
        <tr>
            <th><video id="videoElement" autoplay></video></th>
            <th>
                <div id="predictionResults"></div>
                <button type="button" class="button" id="captureButton">Capture</button>
                <button type="button" class="button" id="switchCameraButton">Switch Camera</button>
            </th>
        </tr>
    </table>

    <script>
        $(document).ready(function() {
            const video = document.getElementById('videoElement');
            let videoStream;
            let currentCamera = 'environment'; // Default to the back camera

            // Function to switch between front and back cameras
            function switchCamera() {
                stopCamera();
                if (currentCamera === 'environment') {
                    currentCamera = 'user';
                } else {
                    currentCamera = 'environment';
                }
                startCamera();
            }

            // Function to start the camera stream
            function startCamera() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: currentCamera } })
                        .then(function(stream) {
                            videoStream = stream;
                            video.srcObject = stream;
                        })
                        .catch(function(error) {
                            console.log(error);
                        });
                }
            }

            // Function to stop the camera stream
            function stopCamera() {
                if (videoStream) {
                    videoStream.getTracks().forEach(function(track) {
                        track.stop();
                    });
                }
            }

            // Function to capture an image from the camera
            function captureImage() {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = canvas.toDataURL('image/jpeg').split(',')[1];
                const binaryData = atob(imageData);
                const arrayBuffer = new ArrayBuffer(binaryData.length);
                const uint8Array = new Uint8Array(arrayBuffer);

                for (let i = 0; i < binaryData.length; i++) {
                    uint8Array[i] = binaryData.charCodeAt(i);
                }

                // Call the custom vision API with the captured image data
                callCustomVisionAPI(arrayBuffer);
            }

            // Function to call the Custom Vision Prediction API and process the response
            function callCustomVisionAPI(imageData) {
                // Replace 'YOUR_PREDICTION_API_KEY' with your actual Prediction API key
                const predictionApiKey = '7b6cff4981894bc8a5ff439840337a85';
                // Replace 'YOUR_PREDICTION_API_ENDPOINT' with your actual Prediction API endpoint
                const predictionApiEndpoint = 'https://southcentralus.api.cognitive.microsoft.com';
                // Replace 'YOUR_PROJECT_ID' with your actual Custom Vision project ID
                const projectId = '54b1b5df-4b57-4f67-b9d0-7c7daf308d87';

                $.ajax({
                    url: `${predictionApiEndpoint}/customvision/v3.0/Prediction/${projectId}/classify/iterations/Iteration1/image`,
                    type: 'POST',
                    beforeSend: function(xhrObj) {
                        xhrObj.setRequestHeader('Content-Type', 'application/octet-stream');
                        xhrObj.setRequestHeader('Prediction-Key', predictionApiKey);
                    },
                    data: imageData,
                    processData: false,
                    success: function(data) {
                        // Process the prediction results
                        displayPredictionResults(data);
                    },
                    error: function(error) {
                        console.log(error);
                    }
                });
            }

            // Function to display the prediction results
            function displayPredictionResults(data) {
                const predictions = data.predictions;
                let resultsHtml = '';
                predictions.forEach(function(prediction) {
                    resultsHtml += `<p>${prediction.tagName}: ${Math.round(prediction.probability * 100)}%</p>`;
                });
                $('#predictionResults').html(resultsHtml);
            }

            // Add event listeners for the capture and switch camera buttons
            $('#captureButton').click(function() {
                captureImage();
            });

            $('#switchCameraButton').click(function() {
                switchCamera();
            });

            // Start the camera stream when the page loads
            startCamera();
        });
    </script>
</body>

</html>